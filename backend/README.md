# Геологический разрез API

Веб-приложение для построения упрощённого геологического разреза по изображению геологической карты, изображению легенды и двум заданным точкам на карте.

## Описание

Приложение строит геологический разрез, который визуализирует последовательность слоёв согласно порядку цветов в легенде. Разрез не отображает реальную геометрию (наклоны, высоты), а показывает упрощённую последовательность геологических слоёв.

## Технологический стек

- **Backend**: FastAPI, Uvicorn
- **Обработка изображений**: OpenCV, NumPy, Pillow
- **Машинное обучение**: scikit-learn (кластеризация)
- **Визуализация**: Matplotlib
- **Валидация данных**: Pydantic

## Установка и запуск

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Запуск приложения

```bash
python run.py
```

Или с помощью uvicorn:

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 3. Доступ к API

После запуска API будет доступен по адресу: http://localhost:8000

- Swagger документация: http://localhost:8000/docs
- ReDoc документация: http://localhost:8000/redoc

## API Endpoints

### POST /api/v1/geological-section/create-section

Создает геологический разрез по карте и легенде.

**Параметры:**
- `map_image` (file): Изображение геологической карты (PNG, JPG, JPEG)
- `legend_image` (file): Изображение легенды (PNG, JPG, JPEG)
- `start_x` (int): X координата начальной точки
- `start_y` (int): Y координата начальной точки
- `end_x` (int): X координата конечной точки
- `end_y` (int): Y координата конечной точки

**Ответ:**
```json
{
  "layers": [
    {
      "color": [255, 0, 0],
      "name": "",
      "order": 0
    }
  ],
  "image_url": "/api/v1/geological-section/download/section_20231201_120000.png",
  "message": "Разрез построен успешно. Найдено 3 слоев."
}
```

### GET /api/v1/geological-section/download/{filename}

Скачивает изображение геологического разреза.

### GET /api/v1/geological-section/health

Проверка состояния API.

## Алгоритм работы

1. **Извлечение цветов из легенды** - порядок цветов сверху вниз определяет порядок слоёв
2. **Построение линии между точками** - извлекается список пикселей вдоль линии
3. **Анализ цветов вдоль линии** - каждый цвет сопоставляется с ближайшим цветом из легенды
4. **Построение слоёв** - при смене цвета:
   - Если новый цвет выше в легенде — новый слой рисуется выше
   - Если ниже — ниже текущего
   - Повторяющиеся цвета игнорируются
5. **Визуализация** - итоговый геологический разрез строится как вертикальная диаграмма

## Ограничения

- Поддерживаются форматы PNG, JPG, JPEG
- Цвета карты должны присутствовать в легенде
- Порядок слоёв строго следует порядку в легенде сверху вниз
- Не строится реальная геометрия разреза (нет рельефа и углов падения)

## Структура проекта

```
geo-back/
├── app/
│   ├── core/
│   │   ├── config.py          # Конфигурация приложения
│   │   └── geological_processor.py  # Основная логика обработки
│   ├── routers/
│   │   └── geological_section.py    # API роутеры
│   ├── main.py                # Основной файл приложения
│   └── schemas.py             # Pydantic схемы
├── uploads/                   # Директория для загруженных файлов
├── outputs/                   # Директория для результатов
├── requirements.txt           # Зависимости
├── run.py                     # Скрипт запуска
└── README.md                 # Документация
```

## Пример использования

1. Подготовьте изображение геологической карты в формате PNG
2. Подготовьте изображение легенды в формате PNG
3. Определите координаты двух точек на карте
4. Отправьте POST запрос на `/api/v1/geological-section/create-section`
5. Получите результат с описанием слоёв и ссылкой на изображение разреза 